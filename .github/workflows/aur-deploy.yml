name: Deploy AUR Packages

on:
  push:
    paths:
      - 'aur-packages/**'
    branches:
      - v3.0
  workflow_dispatch:

jobs:
  deploy-meowrch-settings:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate SHA256 for meowrch-settings
        id: sha256_settings
        run: |
          URL="https://github.com/meowrch/meowrch/archive/refs/heads/v3.0.tar.gz"
          HASH=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          
      - name: Update PKGBUILD with SHA256
        run: |
          sed -i "s/^sha256sums=.*/sha256sums=('${{ steps.sha256_settings.outputs.hash }}')/" aur-packages/meowrch-settings/PKGBUILD
          
      - name: Deploy to AUR
        uses: KSXGitHub/github-actions-deploy-aur@master
        with:
          pkgname: meowrch-settings
          pkgbuild: aur-packages/meowrch-settings/PKGBUILD
          assets: |
            aur-packages/meowrch-settings/meowrch-settings.install
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update meowrch-settings package"
          allow_empty_commits: "true"

  deploy-meowrch-tools:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate SHA256 for meowrch-tools
        id: sha256_tools
        run: |
          URL="https://github.com/meowrch/meowrch/archive/refs/heads/v3.0.tar.gz"
          HASH=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          
      - name: Update PKGBUILD with SHA256
        run: |
          sed -i "s/^sha256sums=.*/sha256sums=('${{ steps.sha256_tools.outputs.hash }}')/" aur-packages/meowrch-tools/PKGBUILD
          
      - name: Deploy to AUR
        uses: KSXGitHub/github-actions-deploy-aur@master
        with:
          pkgname: meowrch-tools
          pkgbuild: aur-packages/meowrch-tools/PKGBUILD
          assets: |
            aur-packages/meowrch-tools/meowrch-tools.install
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update meowrch-tools package"
          allow_empty_commits: "true"
